
## v3 版本更新日志
```go
// 功能层面
// 1.单元测试，重构完善功能
// 	1.1 aggregator是一个静态方法不方便测试时mock（-）（个人感觉获取数据-解析数据-显示数据，每一阶段都经过测试，reporter.Start集成测试，目前为它增加一个类得不尝失）
// 	1.2 输出显示的代码可能会比较复杂（如邮件），可以抽离；提升可读性，可测试性 (+) （view接口或function）
//	1.3 reporter里有重复的代码违反diy原则（+）

// 非功能层面
// 2.易用性提升，封装默认依赖(+)
// 3.性能、容错性提升，同步落盘变为异步落盘，使用eventbus；分批处理大量数据，防止内存溢出
// 4.使用promethos（参考kratos、百度超级链、chainMaker等）
// 5.cron源码，提出来修改（- error不好处理）
```

## metrics总结

最初的功能需求描述是下面这个样子的，我们来重新看一下。

我们希望设计开发一个小的框架，能够获取接口调用的各种统计信息，比如

响应时间的最大值（max）、最小值（min）、平均值（avg）、百分位值（percentile），接口调用次数（count）、频率（tps） 等，

并且支持将统计结果以各种显示格式

（比如：JSON 格式、网页格式、自定义显示格式等）

输出到各种终端

（Console 命令行、HTTP 网页、Email、日志文件、自定义输出终端等），以方便查看。

经过整理拆解之后的需求列表如下所示：接口统计信息：包括接口响应时间的统计信息，以及接口调用次数的统计信息等。

统计信息的类型：max、min、avg、percentile、count、tps 等。

统计信息显示格式：JSON、HTML、自定义显示格式。

统计信息显示终端：Console、Email、HTTP 网页、日志、自定义显示终端。

经过挖掘，我们还得到一些隐藏的需求，如下所示：统计触发方式：包括主动和被动两种。主动表示以一定的频率定时统计数据，并主动推送到显示终端，比如邮件推送。被动表示用户触发统计，比如用户在网页中选择要统计的时间区间，触发统计，并将结果显示给用户。

统计时间区间：框架需要支持自定义统计时间区间，比如统计最近 10 分钟的某接口的 tps、访问次数，或者统计 12 月 11 日 00 点到 12 月 12 日 00 点之间某接口响应时间的最大值、最小值、平均值等。统计时间间隔：对于主动触发统计，我们还要支持指定统计时间间隔，也就是多久触发一次统计显示。比如，每间隔 10s 统计一次接口信息并显示到命令行中，每间隔 24 小时发送一封统计信息邮件。

版本 3 已经实现了大部分的功能，还有以下几个小的功能点没有实现。

- 被动触发统计的方式，也就是需求中提到的通过网页展示统计信息。
- 对于自定义显示终端，比如显示数据到自己开发的监控平台，这就有点类似通过网页来显示数据，不过更加简单些，只需要提供一些获取统计数据的接口，监控平台通过这些接口拉取数据来显示即可。
- 自定义显示格式。在框架现在的代码实现中，显示格式和显示终端（比如 Console、Email）是紧密耦合在一起的，比如，Console 只能通过 JSON 格式来显示统计数据，Email 只能通过某种固定的 HTML 格式显示数据，这样的设计还不够灵活。我们可以将显示格式设计成独立的类，将显示终端和显示格式的代码分离，让显示终端支持配置不同的显示格式。具体的代码实现留给你自己思考，我这里就不多说了。